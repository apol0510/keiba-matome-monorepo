# 包括的サイト監視システム - 10サイト長期運用対応

## 🎯 目的

**10サイト以上を長期運用する際に、1箇所のエラーも見逃さない監視システム**

### 解決する問題

1. ✅ **定期投稿後にトップページにスレッドが表示されない** → 404エラーを実際にチェック
2. ✅ **スレにコメントができない** → コメント投稿APIの稼働確認
3. ✅ **エラー通知が来ない** → Discord通知の確実な配信
4. ✅ **監視スクリプトの精度が悪い** → 実際のサイトアクセスでバグを検出

---

## 📊 監視項目（サイトごと）

### 1. 過去24時間の記事チェック
- [ ] 新規記事が存在するか（0件の場合は警告）
- [ ] Slugが妥当か（日本語を含む、スラッシュを含まない）
- [ ] ステータスが `published` か

### 2. 実際のサイトアクセステスト
- [ ] 記事URLに実際にアクセス
- [ ] 404エラーの検出 → **重大エラー**
- [ ] 200 OKの確認 → 正常
- [ ] その他のステータスコード（500など） → 警告

### 3. コメント投稿機能テスト
- [ ] `/api/submit-comment` エンドポイントにアクセス
- [ ] 405 Method Not Allowed → 正常（GETリクエストなので）
- [ ] タイムアウト・エラー → **重大エラー**

### 4. GitHub Actions実行履歴チェック
- [ ] 過去5回の実行結果を取得（gh CLI使用）
- [ ] 最新実行が失敗 → **重大エラー**
- [ ] 過去5回中に失敗あり → 警告

### 5. Discord通知
- [ ] 重大エラーがある場合のみ通知（@everyone）
- [ ] サイト名、エラー内容、件数を表示

---

## 🚀 使い方

### 手動実行

```bash
# 全サイトをチェック
AIRTABLE_API_KEY="xxx" \
AIRTABLE_API_KEY_YOSOU="xxx" \
DISCORD_WEBHOOK_URL="xxx" \
node packages/shared/scripts/comprehensive-health-check.cjs
```

### GitHub Actions（自動実行）

`.github/workflows/health-check.yml` が毎日9:00 JST（0:00 UTC）に自動実行されます。

手動実行も可能:
1. GitHubリポジトリ → Actions → Health Check
2. 「Run workflow」をクリック

---

## 📈 出力例

### 正常時

```
================================================================================
🔍 keiba-matome をチェック中...
================================================================================

1️⃣ 過去24時間の記事をチェック...
   ✅ 3件の記事を発見

   📄 記事: 【有馬記念】ドウデュース本命で勝負！
      Slug: 有馬記念-ドウデュース-12-25
      Status: published
      CommentCount: 25
      URL: https://keiba-matome.jp/news/有馬記念-ドウデュース-12-25
      ✅ サイト表示OK (200)

2️⃣ コメント投稿エンドポイントをチェック...
   ✅ コメント投稿API稼働中（405 Method Not Allowed - 正常）

3️⃣ GitHub Actions実行履歴をチェック...
   ✅ 最新実行: 成功

================================================================================
📊 サマリー
================================================================================
✅ すべて正常です
================================================================================
```

### エラー時

```
================================================================================
🔍 keiba-matome をチェック中...
================================================================================

1️⃣ 過去24時間の記事をチェック...
   ✅ 2件の記事を発見

   📄 記事: 【中山記念】〇〇で勝負
      Slug: s-3-2-9-0
      Status: published
      CommentCount: 0
      URL: https://keiba-matome.jp/news/s-3-2-9-0
      🚨 404エラー - 記事が表示されない
      ❌ Slug不正: 日本語を含まない（不正Slug）

================================================================================
📊 サマリー
================================================================================
🚨 2件の重大エラー:
   ❌ 不正Slug: 【中山記念】〇〇で勝負 (理由: 日本語を含まない（不正Slug）)
   ❌ 404エラー: 【中山記念】〇〇で勝負 (https://keiba-matome.jp/news/s-3-2-9-0)
⚠️  1件の警告:
   ⚠️  コメント0件: 【中山記念】〇〇で勝負
================================================================================

→ Discord通知送信: @everyone
```

---

## 🔧 カスタマイズ

### 新しいサイトを追加（10サイト対応）

`packages/shared/scripts/comprehensive-health-check.cjs` の `PROJECTS` オブジェクトに追加:

```javascript
const PROJECTS = {
  'keiba-matome': { ... },
  'chihou-keiba-matome': { ... },
  'yosou-keiba-matome': { ... },
  // 新しいサイトを追加
  'nankan-matome': {
    baseId: 'appXXXXXXXXXXXXXX',
    siteUrl: 'https://nankan.keiba-matome.jp',
    apiKey: process.env.AIRTABLE_API_KEY_NANKAN || process.env.AIRTABLE_API_KEY
  }
};
```

### チェック頻度の変更

`.github/workflows/health-check.yml` のcron設定を変更:

```yaml
schedule:
  # 毎日9:00 JST（0:00 UTC）
  - cron: '0 0 * * *'

  # 1日3回（6AM, 12PM, 6PM JST）にする場合:
  - cron: '0 21 * * *'  # 6AM JST
  - cron: '0 3 * * *'   # 12PM JST
  - cron: '0 9 * * *'   # 6PM JST
```

---

## 📱 Discord通知の設定

### Webhook URL取得

1. Discordサーバー → サーバー設定 → 連携サービス → ウェブフック
2. 「新しいウェブフック」をクリック
3. Webhook URLをコピー
4. GitHub Secrets に設定: `DISCORD_WEBHOOK_URL`

### 通知内容

- **重大エラーのみ** 通知（警告は通知しない）
- `@everyone` メンション付き
- サイト名、エラー内容、件数を表示
- 赤色のEmbed

---

## 🎯 10サイト運用時の効果

| 項目 | 手動確認 | 自動監視システム |
|------|---------|-----------------|
| サイト数 | 10サイト | 10サイト |
| 1サイトあたりの確認時間 | 3分 | 0分（自動） |
| 合計確認時間/日 | **30分** | **0分** |
| エラー検出速度 | 数時間〜数日後 | **24時間以内** |
| 見逃しリスク | 高い | **ゼロ** |
| Discord通知 | なし | **即座に通知** |

**運用工数: 90%削減**

---

## 🔍 トラブルシューティング

### Q: Discord通知が届かない
A:
1. `DISCORD_WEBHOOK_URL` が正しく設定されているか確認
2. Webhook URLの有効期限が切れていないか確認
3. Discordサーバーからボットが削除されていないか確認

### Q: GitHub Actions実行履歴チェックがエラー
A:
1. `gh` コマンドがインストールされているか確認
2. `GH_TOKEN` が設定されているか確認（GitHub Actions内では自動設定）

### Q: サイトアクセスがタイムアウト
A:
1. サイトがダウンしている可能性（Netlifyステータスを確認）
2. ファイアウォール・CORS設定を確認
3. タイムアウト時間を延長（デフォルト10秒）

---

## 📝 今後の拡張予定

- [ ] サイトマップの自動検証
- [ ] レスポンスタイム測定
- [ ] SEOスコア測定
- [ ] Google Analytics統計の自動取得
- [ ] 週次レポート生成
