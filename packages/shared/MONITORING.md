# monorepo統合監視システム

## 概要

3つのサイト（keiba-matome, chihou-keiba-matome, yosou-keiba-matome）の健全性を**一箇所で一括チェック**するシステムです。

## 解決する問題

- ❌ 地方競馬記事の混入に気づかない
- ❌ X投稿の404リンクに気づかない
- ❌ サイト数が増えると各サイトのエラーを把握できない

## チェック項目

### 1. 記事数異常検出

- 過去24時間に新規記事が0件 → 🚨 重大エラー（スクレイピング停止の可能性）
- 過去24時間の記事が3件未満 → ⚠️ 警告（通常9-27件）

### 2. 404リンク検出

- Slugに日本語が含まれていない → 🚨 重大エラー
- 例: `/news/c14-1-6-27/` → 404リンク

### 3. フィルタリング漏れ検出

- keiba-matome.jp（中央競馬）に地方競馬記事が混入 → ⚠️ 警告
- 27種類のキーワードで検出:
  - 南関東4競馬: 大井、TCK、船橋、川崎、浦和、南関
  - 全国地方競馬場: 門別、盛岡、水沢、金沢、笠松、名古屋、園田、姫路、高知、佐賀、ホッカイドウ
  - 地方競馬ワード: 地方競馬、地方重賞、NAR
  - 地方G1・重賞: 東京大賞典、川崎記念、帝王賞、ジャパンダートダービー、かしわ記念、JBC、トゥインクル、羽田盃、黒潮盃、兵庫ゴールドトロフィー、東京記念

### 4. SourceURL検証

- 元記事URLが存在しない/不正 → ⚠️ 警告

## 使い方

### 手動実行

```bash
# monorepoルートで実行
AIRTABLE_API_KEY="xxx" DISCORD_WEBHOOK_URL="xxx" node packages/shared/scripts/monitor-all-sites.cjs
```

### 自動実行（GitHub Actions）

毎日9:00 JST（0:00 UTC）に自動実行されます。

- ワークフロー: `.github/workflows/health-check.yml`
- 問題があればDiscord通知

### Discord通知

問題が検出された場合、以下の形式でDiscord通知が届きます：

```
🔍 monorepo統合監視レポート

中央競馬（keiba-matome）
2件の重大エラー、1件の警告

🚨 重大 404リンク
不正なSlug: "c14-1-6-27" - タイトル: "【速報】有馬記念の出走予定馬が発表"
[リンク](https://keiba-matome.jp/news/c14-1-6-27/)

⚠️ 警告 フィルタリング漏れ
地方競馬記事が混入: "【速報】川崎記念の出走予定馬が発表" - キーワード: "川崎"
[リンク](https://keiba-matome.jp/news/kawasaki-kinen-shutsuba/)
```

## 出力例

```
🚀 monorepo統合監視スクリプト開始

🔍 中央競馬（keiba-matome）をチェック中...
  📰 過去24時間の記事数: 9件
  ✅ チェック完了: 0件の問題を検出

🔍 地方競馬（chihou-keiba-matome）をチェック中...
  📰 過去24時間の記事数: 27件
  ✅ チェック完了: 0件の問題を検出

🔍 競馬予想（yosou-keiba-matome）をチェック中...
  📰 過去24時間の記事数: 6件
  ✅ チェック完了: 0件の問題を検出

============================================================
📊 monorepo統合監視レポート
============================================================

中央競馬（keiba-matome）: ✅ 正常
  重大エラー: 0件
  警告: 0件

地方競馬（chihou-keiba-matome）: ✅ 正常
  重大エラー: 0件
  警告: 0件

競馬予想（yosou-keiba-matome）: ✅ 正常
  重大エラー: 0件
  警告: 0件

------------------------------------------------------------
合計: 🚨 0件の重大エラー、⚠️ 0件の警告
============================================================

✅ すべてのサイトが正常です
```

## サイト追加時の対応

新しいサイトを追加する場合、`monitor-all-sites.cjs`の`SITES`配列に追加するだけです：

```javascript
const SITES = [
  // 既存のサイト...
  {
    name: 'new-site',
    displayName: '新サイト',
    baseId: 'appXXXXXXXXXXXXX',
    domain: 'https://new-site.example.com',
    expectedType: '新サイト',
    excludeKeywords: [] // 除外キーワード（必要に応じて）
  }
];
```

## 開発履歴

- 2026-01-06: 初版作成（地方競馬記事混入問題、X投稿404問題に対応）
