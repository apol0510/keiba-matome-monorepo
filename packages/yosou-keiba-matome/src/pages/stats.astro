---
export const prerender = true;

import BaseLayout from '../layouts/BaseLayout.astro';
import { getAllArticles } from '../lib/airtable';

// çš„ä¸­ç‡çµ±è¨ˆã‚’å–å¾—
const articles = await getAllArticles();
const articlesWithResults = articles.filter(a => a.hasResult);

// å…¨ä½“çš„ä¸­ç‡
const totalHits = articlesWithResults.reduce((sum, a) => sum + (a.hitRate || 0), 0);
const averageHitRate = articlesWithResults.length > 0
  ? Math.round(totalHits / articlesWithResults.length)
  : 0;

// ã‚«ãƒ†ã‚´ãƒªåˆ¥çš„ä¸­ç‡
const chuouArticles = articlesWithResults.filter(a => a.category === 'ä¸­å¤®é‡è³');
const nankanJuushouArticles = articlesWithResults.filter(a => a.category === 'å—é–¢é‡è³');
const nankanMainArticles = articlesWithResults.filter(a => a.category === 'å—é–¢ãƒ¡ã‚¤ãƒ³');

const chuouHitRate = chuouArticles.length > 0
  ? Math.round(chuouArticles.reduce((sum, a) => sum + (a.hitRate || 0), 0) / chuouArticles.length)
  : 0;

const nankanJuushouHitRate = nankanJuushouArticles.length > 0
  ? Math.round(nankanJuushouArticles.reduce((sum, a) => sum + (a.hitRate || 0), 0) / nankanJuushouArticles.length)
  : 0;

const nankanMainHitRate = nankanMainArticles.length > 0
  ? Math.round(nankanMainArticles.reduce((sum, a) => sum + (a.hitRate || 0), 0) / nankanMainArticles.length)
  : 0;

// æœ€è¿‘ã®çš„ä¸­çµæœï¼ˆæœ€æ–°10ä»¶ï¼‰
const recentResults = articlesWithResults.slice(0, 10);
---

<BaseLayout title="ğŸ¯ äºˆæƒ³çš„ä¸­ç‡çµ±è¨ˆ">
  <div style="max-width: 900px; margin: 0 auto; padding: 20px;">
    <h1 style="font-size: 24px; font-weight: bold; margin-bottom: 10px; border-bottom: 2px solid #f60; padding-bottom: 5px;">
      ğŸ¯ äºˆæƒ³çš„ä¸­ç‡çµ±è¨ˆ
    </h1>

    <p style="margin-bottom: 20px; color: #666;">
      å½“ã‚µã‚¤ãƒˆã®äºˆæƒ³çš„ä¸­ç‡ã‚’å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã¯éšæ™‚æ›´æ–°ã•ã‚Œã¾ã™ã€‚
    </p>

    <!-- å…¨ä½“çµ±è¨ˆ -->
    <div style="background: #fff; padding: 20px; border: 1px solid #999; margin-bottom: 20px; box-shadow: 2px 2px 4px rgba(0,0,0,0.1);">
      <h2 style="font-size: 18px; font-weight: bold; margin-bottom: 15px; border-left: 4px solid #f60; padding-left: 10px;">
        ğŸ“Š å…¨ä½“çµ±è¨ˆ
      </h2>
      <div style="line-height: 1.8;">
        <p><strong>å¯¾è±¡ãƒ¬ãƒ¼ã‚¹æ•°:</strong> {articlesWithResults.length}ä»¶</p>
        <p style="font-size: 20px; margin-top: 10px;">
          <strong style="color: #f60;">å¹³å‡çš„ä¸­ç‡: {averageHitRate}%</strong>
        </p>
      </div>
    </div>

    <!-- ã‚«ãƒ†ã‚´ãƒªåˆ¥çµ±è¨ˆ -->
    <div style="background: #fff; padding: 20px; border: 1px solid #999; margin-bottom: 20px; box-shadow: 2px 2px 4px rgba(0,0,0,0.1);">
      <h2 style="font-size: 18px; font-weight: bold; margin-bottom: 15px; border-left: 4px solid #f60; padding-left: 10px;">
        ğŸ‡ ã‚«ãƒ†ã‚´ãƒªåˆ¥çµ±è¨ˆ
      </h2>
      <div style="line-height: 2;">
        <p>
          <strong>ä¸­å¤®é‡è³:</strong>
          <span style="font-size: 18px; color: #f60; margin-left: 10px;">{chuouHitRate}%</span>
          <span style="color: #666; margin-left: 10px;">({chuouArticles.length}ä»¶)</span>
        </p>
        <p>
          <strong>å—é–¢é‡è³:</strong>
          <span style="font-size: 18px; color: #f60; margin-left: 10px;">{nankanJuushouHitRate}%</span>
          <span style="color: #666; margin-left: 10px;">({nankanJuushouArticles.length}ä»¶)</span>
        </p>
        <p>
          <strong>å—é–¢ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹:</strong>
          <span style="font-size: 18px; color: #f60; margin-left: 10px;">{nankanMainHitRate}%</span>
          <span style="color: #666; margin-left: 10px;">({nankanMainArticles.length}ä»¶)</span>
        </p>
      </div>
    </div>

    <!-- æœ€è¿‘ã®çš„ä¸­çµæœ -->
    <div style="background: #fff; padding: 20px; border: 1px solid #999; box-shadow: 2px 2px 4px rgba(0,0,0,0.1);">
      <h2 style="font-size: 18px; font-weight: bold; margin-bottom: 15px; border-left: 4px solid #f60; padding-left: 10px;">
        ğŸ“ æœ€è¿‘ã®çš„ä¸­çµæœ
      </h2>
      {recentResults.length === 0 ? (
        <p style="color: #666; padding: 20px; text-align: center;">ã¾ã çš„ä¸­çµæœã¯ã‚ã‚Šã¾ã›ã‚“</p>
      ) : (
        <div>
          {recentResults.map((article, index) => (
            <div style={`border-bottom: ${index < recentResults.length - 1 ? '1px solid #ddd' : 'none'}; padding: 15px 0;`}>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="flex: 1;">
                  <a
                    href={`/news/${article.slug}`}
                    style="font-weight: bold; color: #00e; text-decoration: none; font-size: 15px;"
                  >
                    {article.title}
                  </a>
                  <div style="font-size: 13px; color: #666; margin-top: 5px;">
                    {new Date(article.raceDate).toLocaleDateString('ja-JP')} | {article.track} {article.grade}
                  </div>
                </div>
                <div style="margin-left: 20px; text-align: right;">
                  <span style={`font-size: 20px; font-weight: bold; color: ${(article.hitRate || 0) >= 50 ? '#f60' : '#666'};`}>
                    {article.hitRate}%
                  </span>
                  <div style="font-size: 12px; color: #999; margin-top: 2px;">çš„ä¸­ç‡</div>
                </div>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>

    <!-- çš„ä¸­ç‡ã®èª¬æ˜ -->
    <div style="margin-top: 30px; padding: 15px; background: #fffef0; border: 1px solid #ddd;">
      <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">ğŸ’¡ çš„ä¸­ç‡ã®è¨ˆç®—æ–¹æ³•</h3>
      <p style="font-size: 14px; line-height: 1.6; color: #666;">
        çš„ä¸­ç‡ã¯ã€æœ¬å‘½ãƒ»å¯¾æŠ—ãƒ»å˜ç©´1ãƒ»å˜ç©´2ã®4ã¤ã®äºˆæƒ³ã®ã†ã¡ã€3ç€ä»¥å†…ã«å…¥ã£ãŸé¦¬ã®å‰²åˆã§è¨ˆç®—ã—ã¦ã„ã¾ã™ã€‚<br>
        ä¾‹: æœ¬å‘½ã¨å¯¾æŠ—ãŒ3ç€ä»¥å†…ã«å…¥ã£ãŸå ´åˆ â†’ 2/4 = 50%
      </p>
    </div>

    <!-- ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯ -->
    <div style="margin-top: 30px; text-align: center;">
      <a
        href="/"
        style="display: inline-block; padding: 12px 30px; background: #f60; color: #fff; text-decoration: none; font-weight: bold; border-radius: 4px;"
      >
        â† ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹
      </a>
    </div>
  </div>
</BaseLayout>
