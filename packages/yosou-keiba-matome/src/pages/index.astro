---
// トップページは静的生成（SSG）
export const prerender = true;

import BaseLayout from '../layouts/BaseLayout.astro';
import { config } from '../config';
import { getAllArticles } from '../lib/airtable';

// SEO設定
const siteUrl = 'https://keiba-matome.jp';
const siteName = '競馬ニュースまとめ';
const siteDescription = 'netkeiba、Yahoo!ニュースなどの競馬関連ニュースを2ch/5ch風にまとめています。';

// 構造化データ（JSON-LD） - WebSite
const websiteStructuredData = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": siteName,
  "url": siteUrl,
  "description": siteDescription,
  "inLanguage": "ja-JP",
  "potentialAction": {
    "@type": "SearchAction",
    "target": `${siteUrl}/search?q={search_term_string}`,
    "query-input": "required name=search_term_string"
  }
};

// Airtableから予想記事を取得
let allArticles = [];

try {
  const rawArticles = await getAllArticles();
  // publishedAtを文字列からDateオブジェクトに変換
  allArticles = rawArticles.map(article => ({
    ...article,
    publishedAt: new Date(article.publishedAt)
  }));
  console.log(`✅ 予想記事を${allArticles.length}件取得しました`);
} catch (error) {
  console.warn('Airtableからのデータ取得に失敗しました。');
  console.error(error);
  // モックデータ
  allArticles = [
    {
      title: '【中山 G1】有馬記念 予想スレ【12/25】',
      slug: 'arima-kinen-2025',
      category: '中央重賞',
      publishedAt: new Date('2025-12-14T10:00:00'),
      viewCount: 1234,
      commentCount: 89,
    },
    {
      title: '【大井 SI】ゴールドカップ 予想スレ',
      slug: 'gold-cup-2025',
      category: '南関重賞',
      publishedAt: new Date('2025-12-14T09:30:00'),
      viewCount: 567,
      commentCount: 45,
    },
    {
      title: '【船橋 9R】マリーンカップ 予想スレ',
      slug: 'marine-cup-2025',
      category: '南関メイン',
      publishedAt: new Date('2025-12-14T08:00:00'),
      viewCount: 890,
      commentCount: 123,
    },
  ];
}

// カテゴリ別に分類
const chuouArticles = allArticles.filter(a => a.category === '中央重賞');
const nankanArticles = allArticles.filter(a => a.category === '南関重賞' || a.category === '南関メイン');

// カテゴリに応じたURLパスを取得
function getArticlePath(article: any): string {
  if (article.category === '中央重賞') {
    return `/chuou/${article.slug}/`;
  } else if (article.category === '南関重賞' || article.category === '南関メイン') {
    return `/nankan/${article.slug}/`;
  }
  // フォールバック（通常は発生しない）
  return `/news/${article.slug}/`;
}

// 相対時間を計算
function getRelativeTime(date: Date): string {
  const now = new Date();
  const diff = now.getTime() - date.getTime();
  const hours = Math.floor(diff / (1000 * 60 * 60));
  const days = Math.floor(hours / 24);

  if (hours < 1) {
    const minutes = Math.floor(diff / (1000 * 60));
    return `${minutes}分前`;
  } else if (hours < 24) {
    return `${hours}時間前`;
  } else {
    return `${days}日前`;
  }
}

// 勢いを計算（24時間あたりのレス数）
function calculateMomentum(commentCount: number, publishedAt: Date): number {
  const now = new Date();
  const diff = now.getTime() - publishedAt.getTime();
  const hours = diff / (1000 * 60 * 60);

  // 1時間未満の場合は1時間として計算
  const elapsed = Math.max(hours, 1);

  // 24時間あたりのレス数を計算
  const momentum = Math.round((commentCount / elapsed) * 24);

  return momentum;
}
---

<BaseLayout title="トップ" description={siteDescription}>
  <!-- SEO: 構造化データ（WebSite） -->
  <script slot="head" type="application/ld+json" set:html={JSON.stringify(websiteStructuredData)} />

  <!-- SEO: 構造化データ（ItemList - スレッド一覧） -->
  <script slot="head" type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "ItemList",
    "itemListElement": allArticles.slice(0, 10).map((article, index) => ({
      "@type": "ListItem",
      "position": index + 1,
      "url": `${siteUrl}${getArticlePath(article)}`,
      "name": article.title
    }))
  })} />

  <!-- 板トップ -->
  <div style="background-color: #e6e6dc; border: 1px solid #999; padding: 12px; margin-bottom: 16px;">
    <h1 style="margin: 0 0 8px 0; font-size: 18px; font-weight: bold;">競馬予想板</h1>
    <p style="margin: 0; font-size: 12px; color: #666;">
      netkeiba、Yahoo!競馬などの重賞予想をまとめています。<br />
      中央重賞・南関重賞の予想スレッド
    </p>
  </div>

  <!-- タブナビゲーション -->
  <div style="background-color: #fff; border: 1px solid #999; margin-bottom: 16px;">
    <div style="display: flex; border-bottom: 1px solid #999;">
      <button id="tab-chuou" class="tab-button active" style="flex: 1; padding: 12px; background: #ea8b00; color: #fff; border: none; cursor: pointer; font-weight: bold; font-size: 14px;">
        中央重賞（{chuouArticles.length}件）
      </button>
      <button id="tab-nankan" class="tab-button" style="flex: 1; padding: 12px; background: #e6e6dc; color: #333; border: none; cursor: pointer; font-weight: bold; font-size: 14px; border-left: 1px solid #999;">
        南関重賞（{nankanArticles.length}件）
      </button>
    </div>
  </div>

  <!-- スレッド一覧 -->
  <style>
    /* テーブルレイアウト（全画面サイズ共通） */
    .article-list-table {
      display: table;
      width: 100%;
      border-collapse: collapse;
      background-color: #fff;
      border: 1px solid #999;
      font-size: 13px;
    }

    /* モバイル対応: 小さい画面では少し調整 */
    @media (max-width: 767px) {
      .article-list-table {
        font-size: 11px;
      }
      .article-list-table th,
      .article-list-table td {
        padding: 6px 4px !important;
      }
    }
  </style>

  <!-- テーブルレイアウト（中央重賞） -->
  <table id="content-chuou" class="article-list-table tab-content">
    <thead>
      <tr style="background-color: #e6e6dc; border-bottom: 1px solid #999;">
        <th style="padding: 6px 8px; text-align: left; font-weight: normal;">スレッドタイトル</th>
        <th style="padding: 6px 8px; text-align: center; width: 80px; font-weight: normal;">レス数</th>
        <th style="padding: 6px 8px; text-align: center; width: 80px; font-weight: normal;">勢い</th>
        <th style="padding: 6px 8px; text-align: center; width: 100px; font-weight: normal;">最終更新</th>
      </tr>
    </thead>
    <tbody>
      {chuouArticles.map((article, index) => (
        <tr style={`border-bottom: 1px solid #ddd; ${index % 2 === 0 ? 'background-color: #fafafa;' : 'background-color: #fff;'}`}>
          <td style="padding: 8px;">
            <a
              href={getArticlePath(article)}
              style="color: #0000ff; text-decoration: none;"
              onmouseover="this.style.textDecoration='underline'"
              onmouseout="this.style.textDecoration='none'"
            >
              {article.title}
            </a>
            {article.category && (
              <span style="margin-left: 6px; padding: 2px 6px; background-color: #ea8b00; color: #fff; font-size: 10px; border-radius: 3px;">
                {article.category}
              </span>
            )}
          </td>
          <td style="padding: 8px; text-align: center; color: #666;">
            {article.commentCount || 10}
          </td>
          <td style="padding: 8px; text-align: center; color: #666;">
            {calculateMomentum(article.commentCount || 10, article.publishedAt)}
          </td>
          <td style="padding: 8px; text-align: center; color: #999; font-size: 11px;">
            <span class="relative-time" data-timestamp={article.publishedAt.getTime()}>
              {getRelativeTime(article.publishedAt)}
            </span>
          </td>
        </tr>
      ))}
    </tbody>
  </table>

  <!-- テーブルレイアウト（南関重賞） -->
  <table id="content-nankan" class="article-list-table tab-content" style="display: none;">
    <thead>
      <tr style="background-color: #e6e6dc; border-bottom: 1px solid #999;">
        <th style="padding: 6px 8px; text-align: left; font-weight: normal;">スレッドタイトル</th>
        <th style="padding: 6px 8px; text-align: center; width: 80px; font-weight: normal;">レス数</th>
        <th style="padding: 6px 8px; text-align: center; width: 80px; font-weight: normal;">勢い</th>
        <th style="padding: 6px 8px; text-align: center; width: 100px; font-weight: normal;">最終更新</th>
      </tr>
    </thead>
    <tbody>
      {nankanArticles.map((article, index) => (
        <tr style={`border-bottom: 1px solid #ddd; ${index % 2 === 0 ? 'background-color: #fafafa;' : 'background-color: #fff;'}`}>
          <td style="padding: 8px;">
            <a
              href={getArticlePath(article)}
              style="color: #0000ff; text-decoration: none;"
              onmouseover="this.style.textDecoration='underline'"
              onmouseout="this.style.textDecoration='none'"
            >
              {article.title}
            </a>
            {article.category && (
              <span style="margin-left: 6px; padding: 2px 6px; background-color: #ea8b00; color: #fff; font-size: 10px; border-radius: 3px;">
                {article.category}
              </span>
            )}
          </td>
          <td style="padding: 8px; text-align: center; color: #666;">
            {article.commentCount || 10}
          </td>
          <td style="padding: 8px; text-align: center; color: #666;">
            {calculateMomentum(article.commentCount || 10, article.publishedAt)}
          </td>
          <td style="padding: 8px; text-align: center; color: #999; font-size: 11px;">
            <span class="relative-time" data-timestamp={article.publishedAt.getTime()}>
              {getRelativeTime(article.publishedAt)}
            </span>
          </td>
        </tr>
      ))}
    </tbody>
  </table>

  <!-- 注意書き -->
  <div style="margin-top: 16px; padding: 12px; background-color: #fff3cd; border: 1px solid #ffc107; font-size: 12px; color: #856404;">
    <p style="margin: 0 0 4px 0; font-weight: bold;">⚠️ 注意事項</p>
    <p style="margin: 0;">
      ・このサイトはnetkeiba、Yahoo!ニュースなどから引用した記事に、2ch/5ch風のコメントを追加したまとめサイトです。<br />
      ・コメントはAIによって自動生成されており、実在の人物・団体とは一切関係ありません。<br />
      ・元記事の著作権は各配信元に帰属します。
    </p>
  </div>

  <!-- クライアントサイドで相対時間を更新 -->
  <script>
    // タブ切り替え機能
    function setupTabs() {
      const tabButtons = document.querySelectorAll('.tab-button');

      tabButtons.forEach(button => {
        button.addEventListener('click', function() {
          const tabId = this.id.replace('tab-', '');

          // すべてのタブボタンのスタイルをリセット
          tabButtons.forEach(btn => {
            btn.style.backgroundColor = '#e6e6dc';
            btn.style.color = '#333';
            btn.classList.remove('active');
          });

          // クリックされたタブをアクティブに
          this.style.backgroundColor = '#ea8b00';
          this.style.color = '#fff';
          this.classList.add('active');

          // すべてのコンテンツを非表示
          document.getElementById('content-chuou')?.style.setProperty('display', 'none');
          document.getElementById('content-nankan')?.style.setProperty('display', 'none');

          // 該当するコンテンツを表示（テーブル形式）
          const content = document.getElementById(`content-${tabId}`);
          if (content) {
            content.style.setProperty('display', 'table');
          }
        });
      });
    }

    function updateRelativeTime() {
      const elements = document.querySelectorAll('.relative-time');
      const now = Date.now();

      elements.forEach((el) => {
        const timestamp = parseInt(el.getAttribute('data-timestamp') || '0');
        if (!timestamp) return;

        const diff = now - timestamp;
        const minutes = Math.floor(diff / (1000 * 60));
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const days = Math.floor(hours / 24);

        let text = '';
        if (hours < 1) {
          text = `${minutes}分前`;
        } else if (hours < 24) {
          text = `${hours}時間前`;
        } else {
          text = `${days}日前`;
        }

        el.textContent = text;
      });
    }

    // 初回実行
    setupTabs();
    updateRelativeTime();

    // 1分ごとに更新
    setInterval(updateRelativeTime, 60000);

    // ページ遷移高速化: リンクホバー時にプリフェッチ
    function setupPrefetch() {
      const links = document.querySelectorAll('a[href^="/chuou/"], a[href^="/nankan/"]');
      const prefetchedUrls = new Set();

      links.forEach(link => {
        link.addEventListener('mouseenter', function() {
          const href = this.getAttribute('href');
          if (href && !prefetchedUrls.has(href)) {
            // プリフェッチリンクを作成
            const prefetchLink = document.createElement('link');
            prefetchLink.rel = 'prefetch';
            prefetchLink.href = href;
            document.head.appendChild(prefetchLink);

            // 重複プリフェッチを防ぐ
            prefetchedUrls.add(href);
          }
        }, { once: false });

        // モバイル対応: touchstart時にもプリフェッチ
        link.addEventListener('touchstart', function() {
          const href = this.getAttribute('href');
          if (href && !prefetchedUrls.has(href)) {
            const prefetchLink = document.createElement('link');
            prefetchLink.rel = 'prefetch';
            prefetchLink.href = href;
            document.head.appendChild(prefetchLink);
            prefetchedUrls.add(href);
          }
        }, { passive: true, once: false });
      });
    }

    // ページ読み込み完了後にプリフェッチ設定
    window.addEventListener('load', setupPrefetch);
  </script>
</BaseLayout>
