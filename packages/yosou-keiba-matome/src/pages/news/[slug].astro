---
// SSRãƒ¢ãƒ¼ãƒ‰ï¼ˆæ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’å³åº§ã«è¡¨ç¤ºï¼‰
// â€» ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚·ã‚¹ãƒ†ãƒ ã§é«˜é€ŸåŒ–ç¶­æŒ
export const prerender = false;

import BaseLayout from '../../layouts/BaseLayout.astro';
import { getArticleBySlug, getCommentsByArticleId } from '../../lib/airtable';
import { config } from '../../config';

const { slug } = Astro.params;

// è¨˜äº‹ã‚’å–å¾—
const rawArticle = await getArticleBySlug(slug as string);

// è¨˜äº‹ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯404
if (!rawArticle) {
  return Astro.redirect('/404', 404);
}

// publishedAtã‚’Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
const article = {
  ...rawArticle,
  publishedAt: new Date(rawArticle.publishedAt)
};

// SSGãƒ¢ãƒ¼ãƒ‰ã§ã¯POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã§ããªã„ãŸã‚ã€å‰Šé™¤
// ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã¯Netlify Functionsã§å‡¦ç†

// 2ché¢¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
let comments = [];
try {
  comments = await getCommentsByArticleId(article.id);
  console.log(`âœ… ã‚³ãƒ¡ãƒ³ãƒˆã‚’${comments.length}ä»¶å–å¾—ã—ã¾ã—ãŸ (${article.title})`);
} catch (error) {
  console.error('ã‚³ãƒ¡ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
}

// æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ï¼ˆJSON-LDï¼‰
const structuredData = {
  "@context": "https://schema.org",
  "@type": "NewsArticle",
  "headline": article.title,
  "description": article.summary || article.title,
  "datePublished": article.publishedAt.toISOString(),
  "dateModified": article.publishedAt.toISOString(),
  "author": {
    "@type": "Organization",
    "name": "ç«¶é¦¬äºˆæƒ³ã¾ã¨ã‚",
    "url": config.siteUrl
  },
  "publisher": {
    "@type": "Organization",
    "name": "ç«¶é¦¬äºˆæƒ³ã¾ã¨ã‚",
    "url": config.siteUrl
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": `${config.siteUrl}/news/${article.slug}/`
  },
  "commentCount": comments.length,
  "articleSection": article.category || "ç«¶é¦¬äºˆæƒ³",
  "keywords": `${article.raceName}, ${article.grade}, ç«¶é¦¬äºˆæƒ³`,
  "inLanguage": "ja-JP"
};

// ç›¸å¯¾æ™‚é–“ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
function formatTime(date: Date): string {
  const now = new Date();
  const diff = now.getTime() - date.getTime();
  const minutes = Math.floor(diff / (1000 * 60));
  const hours = Math.floor(diff / (1000 * 60 * 60));
  const days = Math.floor(hours / 24);

  if (minutes < 1) {
    return 'ãŸã£ãŸä»Š';
  } else if (hours < 1) {
    return `${minutes}åˆ†å‰`;
  } else if (hours < 24) {
    return `${hours}æ™‚é–“å‰`;
  } else if (days < 7) {
    return `${days}æ—¥å‰`;
  } else {
    // 7æ—¥ä»¥ä¸Šå‰ã®å ´åˆã¯æ—¥ä»˜è¡¨ç¤º
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][date.getDay()];
    return `${year}/${month}/${day}(${dayOfWeek})`;
  }
}

// URLã‚’æº–å‚™
const siteUrl = config.siteUrl;
const articleUrl = `${siteUrl}/news/${slug}/`;

// Airtableã®structured dataã‚’å„ªå…ˆã€ãªã‘ã‚Œã°ãƒ­ãƒ¼ã‚«ãƒ«ç”Ÿæˆã‚’ä½¿ç”¨
const finalStructuredData = article.structuredData || JSON.stringify(structuredData);
---

<BaseLayout
  title={article.title}
  description={article.summary || article.title}
  ogImage={`/og/articles/${article.slug}.png`}
  metaTitle={article.metaTitle}
  metaDescription={article.metaDescription}
  ogTitle={article.ogTitle}
  ogDescription={article.ogDescription}
  keywords={article.keywords}
  structuredData={finalStructuredData}
>
  <!-- æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ï¼ˆJSON-LDï¼‰ - BaseLayoutã§å‡ºåŠ›ã™ã‚‹ãŸã‚å‰Šé™¤ -->
  <!-- ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œCSS -->
  <style>
    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    .comment-header {
      font-size: 11px;
      color: #666;
      margin-bottom: 6px;
      word-wrap: break-word;
    }
    .comment-content {
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .comment-form-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #999;
      font-size: 14px;
      font-family: inherit;
      box-sizing: border-box;
    }
    .comment-form-textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #999;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      box-sizing: border-box;
      min-height: 100px;
    }
    .submit-button {
      padding: 10px 20px;
      background-color: #ea8b00;
      color: #fff;
      border: 1px solid #999;
      font-size: 14px;
      cursor: pointer;
      width: 100%;
      max-width: 200px;
    }

    /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆä»¥ä¸Š */
    @media (min-width: 768px) {
      .comment-form-input {
        max-width: 300px;
        font-size: 12px;
        padding: 4px;
      }
      .comment-form-textarea {
        max-width: 600px;
        font-size: 12px;
        padding: 4px;
        min-height: 80px;
      }
      .submit-button {
        padding: 6px 16px;
        font-size: 12px;
        width: auto;
      }
    }
  </style>

  <!-- æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ï¼ˆDiscussionForumPostingï¼‰ -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "DiscussionForumPosting",
    "headline": article.title,
    "text": article.summary || article.title,
    "datePublished": article.publishedAt.toISOString(),
    "url": articleUrl,
    "commentCount": comments.length,
    "discussionUrl": articleUrl,
    "author": {
      "@type": "Person",
      "name": "åç„¡ã—ã•ã‚“@ç«¶é¦¬æ¿"
    },
    "publisher": {
      "@type": "Organization",
      "name": "ç«¶é¦¬äºˆæƒ³ã¾ã¨ã‚",
      "url": siteUrl
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": articleUrl
    },
    "comment": comments.slice(0, 10).map(comment => ({
      "@type": "Comment",
      "text": comment.content,
      "dateCreated": new Date(comment.createdAt).toISOString(),
      "author": {
        "@type": "Person",
        "name": "åç„¡ã—ã•ã‚“@ç«¶é¦¬æ¿"
      }
    }))
  })} />

  <!-- ã‚¹ãƒ¬ãƒƒãƒ‰æƒ…å ± -->
  <div style="background-color: #e6e6dc; border: 1px solid #999; padding: 12px; margin-bottom: 16px;">
    <h1 style="margin: 0 0 8px 0; font-size: 16px; font-weight: bold;">{article.title}</h1>
    <p style="margin: 0; font-size: 11px; color: #666;">
      ã‚«ãƒ†ã‚´ãƒª: {article.category} |
      å…¬é–‹æ—¥: {new Date(article.publishedAt).toLocaleDateString('ja-JP')} |
      ãƒ¬ã‚¹æ•°: {comments.length}ä»¶
    </p>
  </div>

  <!-- ãƒ¬ã‚¹ä¸€è¦§ï¼ˆé™çš„ç”Ÿæˆ + å‹•çš„è¿½åŠ ï¼‰ -->
  <div class="comment-list" style="background-color: #fff; border: 1px solid #999; margin-bottom: 16px;">
    {comments.length === 0 ? (
      <div style="padding: 12px; text-align: center; color: #666;">
        ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“
      </div>
    ) : (
      comments.map((comment, index) => {
        const bgColor = comment.number % 2 === 0 ? '#fafafa' : '#fff';
        const opBadge = comment.isOP ? '<span style="margin-left: 4px; padding: 1px 4px; background-color: #ea8b00; color: #fff; font-size: 9px; border-radius: 2px;">ã‚¹ãƒ¬ä¸»</span>' : '';
        const timeStr = formatTime(new Date(comment.createdAt));

        return (
          <div id={`res${comment.number}`} style={`border-bottom: 1px solid #ddd; padding: 12px; background-color: ${bgColor};`}>
            <div class="comment-header">
              <span style="font-weight: bold; color: #000;">{comment.number}</span>
              <span style="margin-left: 8px;">åå‰ï¼š{comment.userName || 'åç„¡ã—ã•ã‚“@ç«¶é¦¬æ¿'}</span>
              {comment.isOP && <span style="margin-left: 4px; padding: 1px 4px; background-color: #ea8b00; color: #fff; font-size: 9px; border-radius: 2px;">ã‚¹ãƒ¬ä¸»</span>}
              <span style="margin-left: 8px;">{timeStr}</span>
              <span style="margin-left: 8px;">{comment.userID}</span>
            </div>
            <div class="comment-content" style="margin-top: 8px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">
              {comment.content}
            </div>
          </div>
        );
      })
    )}
  </div>

  <!-- CTA: è¨˜äº‹ä¸‹ãƒãƒŠãƒ¼ -->
  <div style="background-color: #fff3cd; border: 2px solid #ea8b00; padding: 16px; margin: 16px 0; text-align: center;">
    <p style="margin: 0 0 8px 0; font-size: 16px; font-weight: bold; color: #ea8b00;">
      ğŸ‡ ã“ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã«ã¤ã„ã¦ã‚‚ã£ã¨çŸ¥ã‚ŠãŸã„æ–¹ã¸
    </p>
    <p style="margin: 0 0 12px 0; font-size: 13px; color: #666; line-height: 1.6;">
      ç«¶é¦¬äºˆæƒ³ã‚µã‚¤ãƒˆã®å£ã‚³ãƒŸãƒ»è©•åˆ¤ã‚’500ã‚µã‚¤ãƒˆä»¥ä¸Šæ²è¼‰ä¸­<br />
      è©æ¬ºã‚µã‚¤ãƒˆã‚’é¿ã‘ã¦ã€æœ¬å½“ã«å½“ãŸã‚‹ã‚µã‚¤ãƒˆã‚’è¦‹ã¤ã‘ã‚ˆã†
    </p>
    <a href="https://keiba-review.jp/"
       target="_blank"
       rel="noopener"
       style="display: inline-block; padding: 12px 32px; background-color: #ea8b00; color: #fff; text-decoration: none; border-radius: 4px; font-weight: bold; font-size: 14px;">
      ç„¡æ–™ã§å£ã‚³ãƒŸã‚’è¦‹ã‚‹ â†’
    </a>
  </div>

  <!-- äºˆæƒ³è¨˜äº‹æƒ…å ± -->
  {article.summary && (
    <div style="background-color: #fff; border: 1px solid #999; padding: 12px; margin-bottom: 16px;">
      <p style="margin: 0 0 4px 0; font-size: 11px; color: #666; font-weight: bold;">
        ğŸ‡ ãƒ¬ãƒ¼ã‚¹æƒ…å ±
      </p>
      <p style="margin: 0 0 4px 0; font-size: 13px; line-height: 1.6; color: #333;">
        <strong>{article.raceName}</strong>ï¼ˆ{article.grade}ï¼‰
      </p>
      <p style="margin: 0 0 8px 0; font-size: 12px; color: #666;">
        é–‹å‚¬æ—¥: {article.raceDate} | ç«¶é¦¬å ´: {article.track}
      </p>
      <p style="margin: 0 0 8px 0; font-size: 13px; line-height: 1.6; color: #333; white-space: pre-wrap;">
        {article.summary}
      </p>
      {article.sourceURL && (
        <a href={article.sourceURL}
           target="_blank"
           rel="noopener"
           style="color: #0000ff; text-decoration: none; font-size: 12px;">
          â†’ äºˆæƒ³å…ƒã‚’è¦‹ã‚‹{article.sourceSite ? `ï¼ˆ${article.sourceSite}ï¼‰` : ''}
        </a>
      )}
    </div>
  )}

  <!-- ãƒ¬ã‚¹æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div id="comment-form" style="background-color: #e6e6dc; border: 1px solid #999; padding: 12px; margin-bottom: 16px;">
    <p style="margin: 0 0 8px 0; font-size: 14px; font-weight: bold;">æ›¸ãè¾¼ã‚€</p>

    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆå‹•çš„ï¼‰ -->
    <div id="message-area"></div>

    <form id="submit-form" style="display: flex; flex-direction: column; gap: 12px;">
      <div>
        <label for="userName" style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">åå‰:</label>
        <input
          type="text"
          id="userName"
          name="userName"
          placeholder="åç„¡ã—ã•ã‚“@ç«¶é¦¬æ¿"
          class="comment-form-input"
        />
      </div>
      <div>
        <label for="content" style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">æœ¬æ–‡:</label>
        <textarea
          id="content"
          name="content"
          placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›... (2-500æ–‡å­—)"
          class="comment-form-textarea"
          required
        ></textarea>
      </div>
      <!-- Cloudflare Turnstile CAPTCHA -->
      <div id="cf-turnstile" class="cf-turnstile" data-sitekey="1x00000000000000000000AA" data-theme="light"></div>
      <div>
        <button
          type="submit"
          class="submit-button"
        >
          æ›¸ãè¾¼ã‚€
        </button>
      </div>
    </form>
  </div>

  <!-- æ³¨æ„æ›¸ã -->
  <div style="margin-top: 16px; padding: 12px; background-color: #fff3cd; border: 1px solid #ffc107; font-size: 11px; color: #856404;">
    <p style="margin: 0 0 4px 0; font-weight: bold;">âš ï¸ æ³¨æ„äº‹é …</p>
    <p style="margin: 0;">
      ãƒ»ã“ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã®ã‚³ãƒ¡ãƒ³ãƒˆã®ä¸€éƒ¨ã¯AIã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€‚<br />
      ãƒ»æŠ•ç¨¿ã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚¹ãƒ‘ãƒ åˆ¤å®šå¾Œã€å³åº§ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br />
      ãƒ»URLã‚’å«ã‚€ã‚³ãƒ¡ãƒ³ãƒˆã¯æŠ•ç¨¿ã§ãã¾ã›ã‚“ã€‚
    </p>
  </div>

  <!-- ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§ã«æˆ»ã‚‹ -->
  <div style="margin-top: 16px; text-align: center;">
    <a href="/" style="color: #0000ff; text-decoration: none; font-size: 12px;">
      â† ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§ã«æˆ»ã‚‹
    </a>
  </div>

  <!-- ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ + å³æ™‚åæ˜ ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script define:vars={{ articleId: article.id, currentCommentCount: comments.length }}>
    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
    const form = document.getElementById('submit-form');
    const messageArea = document.getElementById('message-area');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      const content = formData.get('content');
      const userName = formData.get('userName') || 'åç„¡ã—ã•ã‚“@ç«¶é¦¬æ¿';

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!content || content.length < 2) {
        showMessage('ã‚³ãƒ¡ãƒ³ãƒˆã¯2æ–‡å­—ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      if (content.length > 500) {
        showMessage('ã‚³ãƒ¡ãƒ³ãƒˆã¯500æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      if (content.match(/https?:\/\//) || content.match(/www\./)) {
        showMessage('URLã‚’å«ã‚€ã‚³ãƒ¡ãƒ³ãƒˆã¯æŠ•ç¨¿ã§ãã¾ã›ã‚“', 'error');
        return;
      }

      // Cloudflare Turnstile ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
      const turnstileToken = turnstile.getResponse();
      if (!turnstileToken) {
        showMessage('CAPTCHAèªè¨¼ãŒå¿…è¦ã§ã™', 'error');
        return;
      }

      // é€ä¿¡ä¸­è¡¨ç¤º
      const submitButton = form.querySelector('button[type="submit"]');
      const originalButtonText = submitButton.textContent;
      submitButton.disabled = true;
      submitButton.textContent = 'é€ä¿¡ä¸­...';

      try {
        // Netlify Functionsã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        const response = await fetch('/api/submit-comment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            newsId: articleId,
            content: content,
            userName: userName,
            captchaToken: turnstileToken,
          }),
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        showMessage(`âœ… ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¾ã—ãŸï¼ï¼ˆãƒ¬ã‚¹ç•ªå·: ${result.comment.number}ï¼‰`, 'success');

        // ã‚³ãƒ¡ãƒ³ãƒˆã‚’å³åº§ã«è¿½åŠ ï¼ˆDOMæ“ä½œï¼‰
        addCommentToDOM(result.comment);

        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
        form.reset();

        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        setTimeout(() => {
          const newComment = document.getElementById(`res${result.comment.number}`);
          if (newComment) {
            newComment.scrollIntoView({ behavior: 'smooth', block: 'center' });
            newComment.style.transition = 'background-color 0.3s';
            newComment.style.backgroundColor = '#fff9c4';
            setTimeout(() => {
              newComment.style.backgroundColor = '';
            }, 3000);
          }
        }, 100);

      } catch (error) {
        console.error('Comment submission error:', error);
        showMessage('âŒ ' + error.message, 'error');
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = originalButtonText;
      }
    });

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°
    function showMessage(message, type) {
      const bgColor = type === 'success' ? '#d4edda' : '#f8d7da';
      const borderColor = type === 'success' ? '#c3e6cb' : '#f5c6cb';
      const textColor = type === 'success' ? '#155724' : '#721c24';

      messageArea.innerHTML = `
        <div style="background-color: ${bgColor}; border: 1px solid ${borderColor}; padding: 12px; margin-bottom: 12px; font-size: 13px; color: ${textColor};">
          ${message}
        </div>
      `;

      // 5ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
      setTimeout(() => {
        messageArea.innerHTML = '';
      }, 5000);
    }

    // ã‚³ãƒ¡ãƒ³ãƒˆã‚’DOMã«è¿½åŠ ã™ã‚‹é–¢æ•°
    function addCommentToDOM(comment) {
      const commentList = document.querySelector('.comment-list');
      if (!commentList) return;

      const commentNumber = comment.number;
      const bgColor = commentNumber % 2 === 0 ? '#fafafa' : '#fff';

      const commentHtml = `
        <div id="res${commentNumber}" style="border-bottom: 1px solid #ddd; padding: 12px; background-color: ${bgColor};">
          <div class="comment-header" style="font-size: 11px; color: #666; margin-bottom: 6px; word-wrap: break-word;">
            <span style="font-weight: bold; color: #000;">${commentNumber}</span>
            <span style="margin-left: 8px;">åå‰ï¼š${comment.userName}</span>
            <span style="margin-left: 8px;">ãŸã£ãŸä»Š</span>
            <span style="margin-left: 8px;">${comment.userId}</span>
          </div>
          <div class="comment-content" style="font-size: 13px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; margin-top: 8px;">
            ${comment.content}
          </div>
        </div>
      `;

      commentList.insertAdjacentHTML('beforeend', commentHtml);
    }
  </script>

</BaseLayout>
