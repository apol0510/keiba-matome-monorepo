name: Unified Daily Workflow (全サイト統合)

on:
  schedule:
    # 毎日 AM 6:05, 12:00, 18:00 JST（UTC 21:05, 3:00, 9:00）に実行
    # 21:05に変更 - yosou-nankanとの競合回避（21:00起動）
    - cron: '5 21 * * *'  # AM 6:05 JST（競合回避のため5分遅延）
    - cron: '0 3 * * *'   # PM 12:00 JST
    - cron: '0 9 * * *'   # PM 18:00 JST
  workflow_dispatch:
    inputs:
      site:
        description: '実行するサイト（空欄=全サイト）'
        required: false
        type: choice
        options:
          - ''
          - keiba-matome
          - chihou-keiba-matome
      workflow:
        description: 'ワークフロー名'
        required: false
        default: 'daily'
        type: string

concurrency:
  group: unified-daily-${{ github.ref }}-${{ github.event.inputs.site || 'all' }}
  cancel-in-progress: true

jobs:
  run-workflow:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # タイムアウト設定（ハングアップ防止）
    strategy:
      matrix:
        include:
          - site: keiba-matome
            workflow: daily
          - site: chihou-keiba-matome
            workflow: daily
      fail-fast: false  # 1つのサイトが失敗しても他は続行

    steps:
      - name: 実行判定（手動実行時のフィルタリング）
        id: should_run
        run: |
          # スケジュール実行: 常に実行
          if [ "${{ github.event_name }}" == "schedule" ]; then
            echo "result=true" >> $GITHUB_OUTPUT
            echo "✅ スケジュール実行: ${{ matrix.site }} を実行"
            exit 0
          fi

          # 手動実行でサイト未指定: 常に実行
          if [ -z "${{ github.event.inputs.site }}" ]; then
            echo "result=true" >> $GITHUB_OUTPUT
            echo "✅ 手動実行（全サイト）: ${{ matrix.site }} を実行"
            exit 0
          fi

          # 手動実行でサイト指定あり: 一致する場合のみ実行
          if [ "${{ github.event.inputs.site }}" == "${{ matrix.site }}" ]; then
            echo "result=true" >> $GITHUB_OUTPUT
            echo "✅ 手動実行（指定サイト）: ${{ matrix.site }} を実行"
          else
            echo "result=false" >> $GITHUB_OUTPUT
            echo "⏭️  スキップ: ${{ matrix.site }}（${{ github.event.inputs.site }} のみ実行）"
          fi

      - name: リポジトリをチェックアウト
        if: steps.should_run.outputs.result == 'true'
        uses: actions/checkout@v4

      - name: Node.js 20セットアップ
        if: steps.should_run.outputs.result == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 依存関係をインストール
        if: steps.should_run.outputs.result == 'true'
        run: npm install

      - name: ランダム待機（アカウントロック防止）
        if: steps.should_run.outputs.result == 'true'
        run: |
          # 0-3分のランダム待機（GitHub Actions無料枠最適化）
          DELAY=$((RANDOM % 180))
          echo "⏱️  ランダム待機: ${DELAY}秒"
          sleep $DELAY

      - name: ワークフロー実行（リトライ付き）
        if: steps.should_run.outputs.result == 'true'
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 25
          max_attempts: 3
          retry_wait_seconds: 60
          command: |
            node packages/shared/scripts/run-workflow.cjs \
              --site=${{ matrix.site }} \
              --workflow=${{ github.event.inputs.workflow || matrix.workflow }}
        env:
          AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          X_CREDENTIALS_JSON: |
            {
              "KEIBA_MATOME_X": {
                "apiKey": "${{ secrets.KEIBA_MATOME_X_API_KEY }}",
                "apiSecret": "${{ secrets.KEIBA_MATOME_X_API_SECRET }}",
                "accessToken": "${{ secrets.KEIBA_MATOME_X_ACCESS_TOKEN }}",
                "accessSecret": "${{ secrets.KEIBA_MATOME_X_ACCESS_SECRET }}"
              },
              "CHIHOU_X": {
                "apiKey": "${{ secrets.CHIHOU_X_API_KEY }}",
                "apiSecret": "${{ secrets.CHIHOU_X_API_SECRET }}",
                "accessToken": "${{ secrets.CHIHOU_X_ACCESS_TOKEN }}",
                "accessSecret": "${{ secrets.CHIHOU_X_ACCESS_SECRET }}"
              },
              "YOSOU_X": {
                "apiKey": "${{ secrets.YOSOU_X_API_KEY }}",
                "apiSecret": "${{ secrets.YOSOU_X_API_SECRET }}",
                "accessToken": "${{ secrets.YOSOU_X_ACCESS_TOKEN }}",
                "accessSecret": "${{ secrets.YOSOU_X_ACCESS_SECRET }}"
              }
            }
          # Netlify Build Hooks（サイトごと）
          KEIBA_MATOME_NETLIFY_BUILD_HOOK: ${{ secrets.KEIBA_MATOME_NETLIFY_BUILD_HOOK }}
          CHIHOU_KEIBA_NETLIFY_BUILD_HOOK: ${{ secrets.CHIHOU_KEIBA_NETLIFY_BUILD_HOOK }}
          YOSOU_KEIBA_NETLIFY_BUILD_HOOK: ${{ secrets.YOSOU_KEIBA_NETLIFY_BUILD_HOOK }}

      - name: 完了ログ出力
        if: steps.should_run.outputs.result == 'true' && success()
        run: |
          echo "✅ [${{ matrix.site }}] ワークフロー完了"
