name: Unified Daily Workflow (å…¨ã‚µã‚¤ãƒˆçµ±åˆ)

on:
  schedule:
    # æ¯æ—¥ AM 6:00, 12:00, 18:00 JSTï¼ˆUTC 21:00, 3:00, 9:00ï¼‰ã«å®Ÿè¡Œ
    - cron: '0 21 * * *'  # AM 6:00 JST
    - cron: '0 3 * * *'   # PM 12:00 JST
    - cron: '0 9 * * *'   # PM 18:00 JST
  workflow_dispatch:
    inputs:
      site:
        description: 'å®Ÿè¡Œã™ã‚‹ã‚µã‚¤ãƒˆï¼ˆç©ºæ¬„=å…¨ã‚µã‚¤ãƒˆï¼‰'
        required: false
        type: choice
        options:
          - ''
          - keiba-matome
          - chihou-keiba-matome
      workflow:
        description: 'ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å'
        required: false
        default: 'daily'
        type: string

concurrency:
  group: unified-daily-${{ github.ref }}-${{ github.event.inputs.site || 'all' }}
  cancel-in-progress: true

jobs:
  run-workflow:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - site: keiba-matome
            workflow: daily
          - site: chihou-keiba-matome
            workflow: daily
      fail-fast: false  # 1ã¤ã®ã‚µã‚¤ãƒˆãŒå¤±æ•—ã—ã¦ã‚‚ä»–ã¯ç¶šè¡Œ

    steps:
      - name: å®Ÿè¡Œåˆ¤å®šï¼ˆæ‰‹å‹•å®Ÿè¡Œæ™‚ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼‰
        id: should_run
        run: |
          # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ: å¸¸ã«å®Ÿè¡Œ
          if [ "${{ github.event_name }}" == "schedule" ]; then
            echo "result=true" >> $GITHUB_OUTPUT
            echo "âœ… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ: ${{ matrix.site }} ã‚’å®Ÿè¡Œ"
            exit 0
          fi

          # æ‰‹å‹•å®Ÿè¡Œã§ã‚µã‚¤ãƒˆæœªæŒ‡å®š: å¸¸ã«å®Ÿè¡Œ
          if [ -z "${{ github.event.inputs.site }}" ]; then
            echo "result=true" >> $GITHUB_OUTPUT
            echo "âœ… æ‰‹å‹•å®Ÿè¡Œï¼ˆå…¨ã‚µã‚¤ãƒˆï¼‰: ${{ matrix.site }} ã‚’å®Ÿè¡Œ"
            exit 0
          fi

          # æ‰‹å‹•å®Ÿè¡Œã§ã‚µã‚¤ãƒˆæŒ‡å®šã‚ã‚Š: ä¸€è‡´ã™ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
          if [ "${{ github.event.inputs.site }}" == "${{ matrix.site }}" ]; then
            echo "result=true" >> $GITHUB_OUTPUT
            echo "âœ… æ‰‹å‹•å®Ÿè¡Œï¼ˆæŒ‡å®šã‚µã‚¤ãƒˆï¼‰: ${{ matrix.site }} ã‚’å®Ÿè¡Œ"
          else
            echo "result=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  ã‚¹ã‚­ãƒƒãƒ—: ${{ matrix.site }}ï¼ˆ${{ github.event.inputs.site }} ã®ã¿å®Ÿè¡Œï¼‰"
          fi

      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        if: steps.should_run.outputs.result == 'true'
        uses: actions/checkout@v4

      - name: Node.js 20ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        if: steps.should_run.outputs.result == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        if: steps.should_run.outputs.result == 'true'
        run: npm install

      - name: ãƒ©ãƒ³ãƒ€ãƒ å¾…æ©Ÿï¼ˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒƒã‚¯é˜²æ­¢ï¼‰
        if: steps.should_run.outputs.result == 'true'
        run: |
          # 0-3åˆ†ã®ãƒ©ãƒ³ãƒ€ãƒ å¾…æ©Ÿï¼ˆGitHub Actionsç„¡æ–™æ æœ€é©åŒ–ï¼‰
          DELAY=$((RANDOM % 180))
          echo "â±ï¸  ãƒ©ãƒ³ãƒ€ãƒ å¾…æ©Ÿ: ${DELAY}ç§’"
          sleep $DELAY

      - name: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ
        if: steps.should_run.outputs.result == 'true'
        env:
          AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          X_CREDENTIALS_JSON: |
            {
              "KEIBA_MATOME_X": {
                "apiKey": "${{ secrets.KEIBA_MATOME_X_API_KEY }}",
                "apiSecret": "${{ secrets.KEIBA_MATOME_X_API_SECRET }}",
                "accessToken": "${{ secrets.KEIBA_MATOME_X_ACCESS_TOKEN }}",
                "accessSecret": "${{ secrets.KEIBA_MATOME_X_ACCESS_SECRET }}"
              },
              "CHIHOU_X": {
                "apiKey": "${{ secrets.CHIHOU_X_API_KEY }}",
                "apiSecret": "${{ secrets.CHIHOU_X_API_SECRET }}",
                "accessToken": "${{ secrets.CHIHOU_X_ACCESS_TOKEN }}",
                "accessSecret": "${{ secrets.CHIHOU_X_ACCESS_SECRET }}"
              },
              "YOSOU_X": {
                "apiKey": "${{ secrets.YOSOU_X_API_KEY }}",
                "apiSecret": "${{ secrets.YOSOU_X_API_SECRET }}",
                "accessToken": "${{ secrets.YOSOU_X_ACCESS_TOKEN }}",
                "accessSecret": "${{ secrets.YOSOU_X_ACCESS_SECRET }}"
              }
            }
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          # Netlify Build Hooksï¼ˆã‚µã‚¤ãƒˆã”ã¨ï¼‰
          KEIBA_MATOME_NETLIFY_BUILD_HOOK: ${{ secrets.KEIBA_MATOME_NETLIFY_BUILD_HOOK }}
          CHIHOU_KEIBA_NETLIFY_BUILD_HOOK: ${{ secrets.CHIHOU_KEIBA_NETLIFY_BUILD_HOOK }}
          YOSOU_KEIBA_NETLIFY_BUILD_HOOK: ${{ secrets.YOSOU_KEIBA_NETLIFY_BUILD_HOOK }}
        run: |
          node packages/shared/scripts/run-workflow.cjs \
            --site=${{ matrix.site }} \
            --workflow=${{ github.event.inputs.workflow || matrix.workflow }}

      - name: å®Œäº†ãƒ­ã‚°å‡ºåŠ›
        if: steps.should_run.outputs.result == 'true' && success()
        run: |
          echo "âœ… [${{ matrix.site }}] ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†"

      - name: Discordé€šçŸ¥ï¼ˆå¤±æ•—æ™‚ï¼‰
        if: steps.should_run.outputs.result == 'true' && failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            # ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’å–å¾—
            ERROR_LOG="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

            curl -X POST "$DISCORD_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d "{
                \"content\": \"@everyone\",
                \"embeds\": [{
                  \"title\": \"ğŸš¨ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¤±æ•—\",
                  \"description\": \"**ã‚µã‚¤ãƒˆ**: ${{ matrix.site }}\\n**ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: ${{ github.event.inputs.workflow || matrix.workflow }}\\n**å®Ÿè¡Œæ™‚åˆ»**: $(date '+%Y-%m-%d %H:%M:%S JST')\\n**ãƒ­ã‚°**: [ç¢ºèªã™ã‚‹]($ERROR_LOG)\",
                  \"color\": 15158332,
                  \"footer\": {\"text\": \"GitHub Actions\"},
                  \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
                }]
              }"
          fi
          echo "âŒ [${{ matrix.site }}] ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¤±æ•—"
          exit 1
