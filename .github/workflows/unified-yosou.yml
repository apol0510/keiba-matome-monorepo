name: Unified Yosou Workflow (ç«¶é¦¬äºˆæƒ³çµ±åˆ)

on:
  schedule:
    # å—é–¢ãƒ¡ã‚¤ãƒ³: æœˆã€œé‡‘ æœ6æ™‚ã€æ˜¼12æ™‚ã€å¤•æ–¹18æ™‚ï¼ˆJSTï¼‰
    - cron: '0 21 * * 0-4'  # æ—¥ã€œæœ¨ã®21æ™‚UTC = æœˆã€œé‡‘ã®6æ™‚JST
    - cron: '0 3 * * 1-5'   # æœˆã€œé‡‘ã®3æ™‚UTC = æœˆã€œé‡‘ã®12æ™‚JST
    - cron: '0 9 * * 1-5'   # æœˆã€œé‡‘ã®9æ™‚UTC = æœˆã€œé‡‘ã®18æ™‚JST
    # ä¸­å¤®é‡è³: ç«æ›œãƒ»é‡‘æ›œ 18æ™‚ï¼ˆJSTï¼‰
    - cron: '0 9 * * 2'     # ç«æ›œ 9æ™‚UTC = ç«æ›œ 18æ™‚JST
    - cron: '0 9 * * 5'     # é‡‘æ›œ 9æ™‚UTC = é‡‘æ›œ 18æ™‚JST
  workflow_dispatch:
    inputs:
      workflow:
        description: 'ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å'
        required: true
        type: choice
        options:
          - nankan-daily
          - chuou-weekly

concurrency:
  group: unified-yosou-${{ github.ref }}-${{ github.event.inputs.workflow || 'auto' }}
  cancel-in-progress: true

jobs:
  determine-workflow:
    runs-on: ubuntu-latest
    outputs:
      nankan: ${{ steps.decide.outputs.nankan }}
      chuou: ${{ steps.decide.outputs.chuou }}
    steps:
      - name: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼åˆ¤å®š
        id: decide
        run: |
          # æ‰‹å‹•å®Ÿè¡Œæ™‚
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.workflow }}" == "nankan-daily" ]; then
              echo "nankan=true" >> $GITHUB_OUTPUT
              echo "chuou=false" >> $GITHUB_OUTPUT
            else
              echo "nankan=false" >> $GITHUB_OUTPUT
              echo "chuou=true" >> $GITHUB_OUTPUT
            fi
            exit 0
          fi

          # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œæ™‚ï¼šæ›œæ—¥ã¨æ™‚åˆ»ã§åˆ¤å®š
          DAY=$(date +%u)  # 1=æœˆæ›œã€7=æ—¥æ›œ
          HOUR=$(date +%H)

          # å—é–¢ãƒ¡ã‚¤ãƒ³ï¼ˆæœˆã€œé‡‘ã®6/12/18æ™‚ï¼‰
          if [ $DAY -ge 1 ] && [ $DAY -le 5 ]; then
            echo "nankan=true" >> $GITHUB_OUTPUT
          else
            echo "nankan=false" >> $GITHUB_OUTPUT
          fi

          # ä¸­å¤®é‡è³ï¼ˆç«æ›œãƒ»é‡‘æ›œã®18æ™‚ï¼‰
          if ([ $DAY -eq 2 ] || [ $DAY -eq 5 ]) && [ "$HOUR" == "09" ]; then
            echo "chuou=true" >> $GITHUB_OUTPUT
          else
            echo "chuou=false" >> $GITHUB_OUTPUT
          fi

  run-nankan:
    needs: determine-workflow
    if: needs.determine-workflow.outputs.nankan == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: nankan-analytics ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          repository: apol0510/nankan-analytics
          token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          path: nankan-analytics

      - name: Node.js 20ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm install

      - name: nankan-analyticsãƒ‡ãƒ¼ã‚¿ç¢ºèª
        id: check_data
        run: |
          DATA_FILE="nankan-analytics/astro-site/src/data/allRacesPrediction.json"
          if [ ! -f "$DATA_FILE" ]; then
            echo "status=no_data" >> $GITHUB_OUTPUT
            echo "âš ï¸  nankan-analyticsã®ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          else
            echo "status=ok" >> $GITHUB_OUTPUT
            echo "âœ… nankan-analyticsã®ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª"
          fi

      - name: ãƒ©ãƒ³ãƒ€ãƒ å¾…æ©Ÿï¼ˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒƒã‚¯é˜²æ­¢ï¼‰
        if: steps.check_data.outputs.status == 'ok'
        run: |
          DELAY=$((RANDOM % 900))
          echo "â±ï¸  ãƒ©ãƒ³ãƒ€ãƒ å¾…æ©Ÿ: ${DELAY}ç§’"
          sleep $DELAY

      - name: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œï¼ˆå—é–¢ãƒ¡ã‚¤ãƒ³ï¼‰
        if: steps.check_data.outputs.status == 'ok'
        env:
          AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          X_CREDENTIALS_JSON: |
            {
              "KEIBA_MATOME_X": {
                "apiKey": "${{ secrets.KEIBA_MATOME_X_API_KEY }}",
                "apiSecret": "${{ secrets.KEIBA_MATOME_X_API_SECRET }}",
                "accessToken": "${{ secrets.KEIBA_MATOME_X_ACCESS_TOKEN }}",
                "accessSecret": "${{ secrets.KEIBA_MATOME_X_ACCESS_SECRET }}"
              },
              "CHIHOU_X": {
                "apiKey": "${{ secrets.CHIHOU_X_API_KEY }}",
                "apiSecret": "${{ secrets.CHIHOU_X_API_SECRET }}",
                "accessToken": "${{ secrets.CHIHOU_X_ACCESS_TOKEN }}",
                "accessSecret": "${{ secrets.CHIHOU_X_ACCESS_SECRET }}"
              },
              "YOSOU_X": {
                "apiKey": "${{ secrets.YOSOU_X_API_KEY }}",
                "apiSecret": "${{ secrets.YOSOU_X_API_SECRET }}",
                "accessToken": "${{ secrets.YOSOU_X_ACCESS_TOKEN }}",
                "accessSecret": "${{ secrets.YOSOU_X_ACCESS_SECRET }}"
              }
            }
          YOSOU_KEIBA_NETLIFY_BUILD_HOOK: ${{ secrets.YOSOU_KEIBA_NETLIFY_BUILD_HOOK }}
          NANKAN_JSON_PATH: ${{ github.workspace }}/nankan-analytics/astro-site/src/data/allRacesPrediction.json
        run: |
          node packages/shared/scripts/run-workflow.cjs \
            --site=yosou-keiba-matome \
            --workflow=nankan-daily

      - name: Discordé€šçŸ¥ï¼ˆå—é–¢ãƒ»æˆåŠŸæ™‚ï¼‰
        if: success() && needs.determine-workflow.outputs.nankan == 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -X POST "$DISCORD_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d "{\"embeds\":[{\"title\":\"âœ… å—é–¢ãƒ¡ã‚¤ãƒ³äºˆæƒ³ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æˆåŠŸ\",\"description\":\"**ã‚µã‚¤ãƒˆ**: yosou-keiba-matome\\n**å®Ÿè¡Œæ™‚åˆ»**: $(date '+%Y-%m-%d %H:%M:%S JST')\",\"color\":3066993}]}"
          fi

      - name: Discordé€šçŸ¥ï¼ˆå—é–¢ãƒ»å¤±æ•—æ™‚ï¼‰
        if: failure() && needs.determine-workflow.outputs.nankan == 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            ERROR_LOG="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            curl -X POST "$DISCORD_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d "{\"content\":\"@everyone\",\"embeds\":[{\"title\":\"ğŸš¨ å—é–¢ãƒ¡ã‚¤ãƒ³äºˆæƒ³ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¤±æ•—\",\"description\":\"**ã‚µã‚¤ãƒˆ**: yosou-keiba-matome\\n**å®Ÿè¡Œæ™‚åˆ»**: $(date '+%Y-%m-%d %H:%M:%S JST')\\n**ãƒ­ã‚°**: [ç¢ºèªã™ã‚‹]($ERROR_LOG)\",\"color\":15158332}]}"
          fi
          exit 1

  run-chuou:
    needs: determine-workflow
    if: needs.determine-workflow.outputs.chuou == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.js 20ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm install

      - name: ãƒ©ãƒ³ãƒ€ãƒ å¾…æ©Ÿï¼ˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒƒã‚¯é˜²æ­¢ï¼‰
        run: |
          DELAY=$((RANDOM % 900))
          echo "â±ï¸  ãƒ©ãƒ³ãƒ€ãƒ å¾…æ©Ÿ: ${DELAY}ç§’"
          sleep $DELAY

      - name: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œï¼ˆä¸­å¤®é‡è³ï¼‰
        env:
          AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          X_CREDENTIALS_JSON: |
            {
              "KEIBA_MATOME_X": {
                "apiKey": "${{ secrets.KEIBA_MATOME_X_API_KEY }}",
                "apiSecret": "${{ secrets.KEIBA_MATOME_X_API_SECRET }}",
                "accessToken": "${{ secrets.KEIBA_MATOME_X_ACCESS_TOKEN }}",
                "accessSecret": "${{ secrets.KEIBA_MATOME_X_ACCESS_SECRET }}"
              },
              "CHIHOU_X": {
                "apiKey": "${{ secrets.CHIHOU_X_API_KEY }}",
                "apiSecret": "${{ secrets.CHIHOU_X_API_SECRET }}",
                "accessToken": "${{ secrets.CHIHOU_X_ACCESS_TOKEN }}",
                "accessSecret": "${{ secrets.CHIHOU_X_ACCESS_SECRET }}"
              },
              "YOSOU_X": {
                "apiKey": "${{ secrets.YOSOU_X_API_KEY }}",
                "apiSecret": "${{ secrets.YOSOU_X_API_SECRET }}",
                "accessToken": "${{ secrets.YOSOU_X_ACCESS_TOKEN }}",
                "accessSecret": "${{ secrets.YOSOU_X_ACCESS_SECRET }}"
              }
            }
          YOSOU_KEIBA_NETLIFY_BUILD_HOOK: ${{ secrets.YOSOU_KEIBA_NETLIFY_BUILD_HOOK }}
        run: |
          node packages/shared/scripts/run-workflow.cjs \
            --site=yosou-keiba-matome \
            --workflow=chuou-weekly

      - name: Discordé€šçŸ¥ï¼ˆä¸­å¤®ãƒ»æˆåŠŸæ™‚ï¼‰
        if: success() && needs.determine-workflow.outputs.chuou == 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -X POST "$DISCORD_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d "{\"embeds\":[{\"title\":\"âœ… ä¸­å¤®é‡è³äºˆæƒ³ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æˆåŠŸ\",\"description\":\"**ã‚µã‚¤ãƒˆ**: yosou-keiba-matome\\n**å®Ÿè¡Œæ™‚åˆ»**: $(date '+%Y-%m-%d %H:%M:%S JST')\",\"color\":3066993}]}"
          fi

      - name: Discordé€šçŸ¥ï¼ˆä¸­å¤®ãƒ»å¤±æ•—æ™‚ï¼‰
        if: failure() && needs.determine-workflow.outputs.chuou == 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            ERROR_LOG="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            curl -X POST "$DISCORD_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d "{\"content\":\"@everyone\",\"embeds\":[{\"title\":\"ğŸš¨ ä¸­å¤®é‡è³äºˆæƒ³ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¤±æ•—\",\"description\":\"**ã‚µã‚¤ãƒˆ**: yosou-keiba-matome\\n**å®Ÿè¡Œæ™‚åˆ»**: $(date '+%Y-%m-%d %H:%M:%S JST')\\n**ãƒ­ã‚°**: [ç¢ºèªã™ã‚‹]($ERROR_LOG)\",\"color\":15158332}]}"
          fi
          exit 1
