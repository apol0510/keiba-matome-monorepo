name: Unified Yosou Workflow (競馬予想統合)

on:
  schedule:
    # 南関メイン: 月〜金 朝6時、昼12時、夕方18時（JST）
    - cron: '0 21 * * 0-4'  # 日〜木の21時UTC = 月〜金の6時JST
    - cron: '0 3 * * 1-5'   # 月〜金の3時UTC = 月〜金の12時JST
    - cron: '0 9 * * 1-5'   # 月〜金の9時UTC = 月〜金の18時JST
    # 中央重賞: 火曜・金曜 18時（JST）
    - cron: '0 9 * * 2'     # 火曜 9時UTC = 火曜 18時JST
    - cron: '0 9 * * 5'     # 金曜 9時UTC = 金曜 18時JST
  workflow_dispatch:
    inputs:
      workflow:
        description: 'ワークフロー名'
        required: true
        type: choice
        options:
          - nankan-daily
          - chuou-weekly

concurrency:
  group: unified-yosou-${{ github.ref }}-${{ github.event.inputs.workflow || 'auto' }}
  cancel-in-progress: true

jobs:
  determine-workflow:
    runs-on: ubuntu-latest
    outputs:
      nankan: ${{ steps.decide.outputs.nankan }}
      chuou: ${{ steps.decide.outputs.chuou }}
    steps:
      - name: ワークフロー判定
        id: decide
        run: |
          # 手動実行時
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.workflow }}" == "nankan-daily" ]; then
              echo "nankan=true" >> $GITHUB_OUTPUT
              echo "chuou=false" >> $GITHUB_OUTPUT
            else
              echo "nankan=false" >> $GITHUB_OUTPUT
              echo "chuou=true" >> $GITHUB_OUTPUT
            fi
            exit 0
          fi

          # スケジュール実行時：曜日と時刻で判定
          DAY=$(date +%u)  # 1=月曜、7=日曜
          HOUR=$(date +%H)

          # 南関メイン（月〜金の6/12/18時）
          if [ $DAY -ge 1 ] && [ $DAY -le 5 ]; then
            echo "nankan=true" >> $GITHUB_OUTPUT
          else
            echo "nankan=false" >> $GITHUB_OUTPUT
          fi

          # 中央重賞（火曜・金曜の18時）
          if ([ $DAY -eq 2 ] || [ $DAY -eq 5 ]) && [ "$HOUR" == "09" ]; then
            echo "chuou=true" >> $GITHUB_OUTPUT
          else
            echo "chuou=false" >> $GITHUB_OUTPUT
          fi

  run-nankan:
    needs: determine-workflow
    if: needs.determine-workflow.outputs.nankan == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v4

      - name: nankan-analytics リポジトリをチェックアウト
        uses: actions/checkout@v4
        with:
          repository: apol0510/nankan-analytics
          token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          path: nankan-analytics

      - name: Node.js 20セットアップ
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 依存関係をインストール
        run: npm install

      - name: nankan-analyticsデータ確認
        id: check_data
        run: |
          DATA_FILE="nankan-analytics/astro-site/src/data/allRacesPrediction.json"
          if [ ! -f "$DATA_FILE" ]; then
            echo "status=no_data" >> $GITHUB_OUTPUT
            echo "⚠️  nankan-analyticsのデータファイルが見つかりません"
          else
            echo "status=ok" >> $GITHUB_OUTPUT
            echo "✅ nankan-analyticsのデータファイルを確認"
          fi

      - name: ランダム待機（アカウントロック防止）
        if: steps.check_data.outputs.status == 'ok'
        run: |
          DELAY=$((RANDOM % 900))
          echo "⏱️  ランダム待機: ${DELAY}秒"
          sleep $DELAY

      - name: ワークフロー実行（南関メイン）
        if: steps.check_data.outputs.status == 'ok'
        env:
          AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          X_CREDENTIALS_JSON: ${{ secrets.X_CREDENTIALS_JSON }}
          YOSOU_KEIBA_NETLIFY_BUILD_HOOK: ${{ secrets.YOSOU_KEIBA_NETLIFY_BUILD_HOOK }}
          NANKAN_JSON_PATH: ${{ github.workspace }}/nankan-analytics/astro-site/src/data/allRacesPrediction.json
        run: |
          node packages/shared/scripts/run-workflow.cjs \
            --site=yosou-keiba-matome \
            --workflow=nankan-daily

  run-chuou:
    needs: determine-workflow
    if: needs.determine-workflow.outputs.chuou == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v4

      - name: Node.js 20セットアップ
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 依存関係をインストール
        run: npm install

      - name: ランダム待機（アカウントロック防止）
        run: |
          DELAY=$((RANDOM % 900))
          echo "⏱️  ランダム待機: ${DELAY}秒"
          sleep $DELAY

      - name: ワークフロー実行（中央重賞）
        env:
          AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          X_CREDENTIALS_JSON: ${{ secrets.X_CREDENTIALS_JSON }}
          YOSOU_KEIBA_NETLIFY_BUILD_HOOK: ${{ secrets.YOSOU_KEIBA_NETLIFY_BUILD_HOOK }}
        run: |
          node packages/shared/scripts/run-workflow.cjs \
            --site=yosou-keiba-matome \
            --workflow=chuou-weekly
