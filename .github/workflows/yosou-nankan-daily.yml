name: Yosou Nankan Daily (å—é–¢ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹äºˆæƒ³)

on:
  schedule:
    # æœˆã€œé‡‘ æœ6æ™‚ï¼ˆJSTï¼‰ï¼‹æ˜¼12æ™‚ï¼ˆJSTï¼‰ï¼‹å¤•æ–¹18æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    # æ—¥ã€œæœ¨ã®21æ™‚UTC = æœˆã€œé‡‘ã®6æ™‚JSTï¼ˆæœï¼‰
    - cron: '0 21 * * 0-4'
    # æœˆã€œé‡‘ã®3æ™‚UTC = æœˆã€œé‡‘ã®12æ™‚JSTï¼ˆæ˜¼ï¼‰
    - cron: '0 3 * * 1-5'
    # æœˆã€œé‡‘ã®9æ™‚UTC = æœˆã€œé‡‘ã®18æ™‚JSTï¼ˆå¤•æ–¹ï¼‰
    - cron: '0 9 * * 1-5'
  workflow_dispatch:
    inputs:
      skip_comments:
        description: 'ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆã‚’ã‚¹ã‚­ãƒƒãƒ—'
        required: false
        default: 'false'
        type: boolean

jobs:
  generate-nankan-prediction:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/yosou-keiba-matome

    steps:
      - name: Checkout keiba-matome-monorepo
        uses: actions/checkout@v4

      - name: Checkout nankan-analytics
        uses: actions/checkout@v4
        with:
          repository: apol0510/nankan-analytics
          token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          path: nankan-analytics

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        working-directory: .
        run: npm install

      - name: Check nankan-analytics data
        id: check_data
        working-directory: ${{ github.workspace }}
        run: |
          DATA_FILE="nankan-analytics/astro-site/src/data/allRacesPrediction.json"
          if [ ! -f "$DATA_FILE" ]; then
            echo "status=no_data" >> $GITHUB_OUTPUT
            echo "âš ï¸ nankan-analyticsã®ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          else
            echo "status=ok" >> $GITHUB_OUTPUT
            echo "âœ… nankan-analyticsã®ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª"
            cat "$DATA_FILE" | head -20
          fi

      - name: Scrape nankan-analytics daily prediction
        if: steps.check_data.outputs.status == 'ok'
        env:
          AIRTABLE_API_KEY: ${{ secrets.YOSOU_KEIBA_AIRTABLE_API_KEY }}
          AIRTABLE_BASE_ID: ${{ secrets.YOSOU_KEIBA_AIRTABLE_BASE_ID }}
          NANKAN_JSON_PATH: ${{ github.workspace }}/nankan-analytics/astro-site/src/data/allRacesPrediction.json
        run: node scripts/scrape-nankan-daily.cjs

      - name: Generate SEO metadata for new articles
        if: steps.check_data.outputs.status == 'ok'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          AIRTABLE_API_KEY: ${{ secrets.YOSOU_KEIBA_AIRTABLE_API_KEY }}
        run: node ../shared/scripts/generate-seo-for-new-articles.cjs --project=yosou-keiba-matome

      - name: Generate 2ch-style comments
        if: steps.check_data.outputs.status == 'ok' && github.event.inputs.skip_comments != 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          AIRTABLE_API_KEY: ${{ secrets.YOSOU_KEIBA_AIRTABLE_API_KEY }}
          AIRTABLE_BASE_ID: ${{ secrets.YOSOU_KEIBA_AIRTABLE_BASE_ID }}
        run: node scripts/generate-2ch-comments.cjs

      - name: Post to X (Twitter)
        if: success()
        env:
          AIRTABLE_API_KEY: ${{ secrets.YOSOU_KEIBA_AIRTABLE_API_KEY }}
          AIRTABLE_BASE_ID: ${{ secrets.YOSOU_KEIBA_AIRTABLE_BASE_ID }}
          X_API_KEY: ${{ secrets.YOSOU_X_API_KEY }}
          X_API_SECRET: ${{ secrets.YOSOU_X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.YOSOU_X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.YOSOU_X_ACCESS_SECRET }}
          SITE_URL: https://yosou.keiba-matome.jp
        run: node scripts/post-to-x.cjs

      - name: Trigger Netlify Build Hook
        if: success()
        env:
          NETLIFY_BUILD_HOOK: ${{ secrets.YOSOU_KEIBA_NETLIFY_BUILD_HOOK }}
        run: |
          if [ -n "$NETLIFY_BUILD_HOOK" ]; then
            echo "ğŸš€ Netlifyã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ãƒˆãƒªã‚¬ãƒ¼ä¸­..."
            curl -sS -X POST -H "Content-Type: application/json" -d '{}' "$NETLIFY_BUILD_HOOK"
            echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡å®Œäº†"
          else
            echo "â­ï¸  NETLIFY_BUILD_HOOKæœªè¨­å®šã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—"
          fi

      # Discordé€šçŸ¥ã¯ç„¡åŠ¹åŒ–ï¼ˆGitHub Actionsã®çµæœã¯ãƒ¡ãƒ¼ãƒ«ã§å—ä¿¡ï¼‰

      - name: Notify on success
        if: success()
        run: |
          echo "âœ… ã€å—é–¢ãƒ¡ã‚¤ãƒ³ã€‘2ché¢¨äºˆæƒ³ã¾ã¨ã‚æŠ•ç¨¿å®Œäº†"
          echo "ğŸŒ Netlifyãƒ‡ãƒ—ãƒ­ã‚¤: ãƒˆãƒªã‚¬ãƒ¼æ¸ˆã¿"

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ ã€å—é–¢ãƒ¡ã‚¤ãƒ³ã€‘äºˆæƒ³ã¾ã¨ã‚æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ"
          exit 1
